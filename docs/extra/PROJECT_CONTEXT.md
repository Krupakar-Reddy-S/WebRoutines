# WebRoutines Project Context (Full Technical Brief)

## Why this document exists
This file is a self-contained technical brief for WebRoutines.
Use it with any regular chat assistant to discuss new ideas, UX changes, architecture options, and roadmap planning without needing to share the full codebase.

## 1) Product snapshot
WebRoutines is a Chrome MV3 extension that helps users run ordered website routines.

Core concept:
- A user defines routines (named lists of URLs).
- A user can run each routine in a tab-group-backed runner.
- Multiple routines can run at the same time.
- There is only one active runner per routine.

Current UX split:
- Sidepanel default view: Runner Home (active runner control).
- Sidepanel management view: Routines list + start/edit/delete/import/export.
- Sidepanel editor view: dedicated create/edit workflow.
- Popup: quick controls for the currently focused runner.

## 2) Tech stack and runtime
- Framework/tooling: WXT + React + TypeScript.
- Styling/UI: Tailwind v4 + shadcn/ui (base-nova style).
- Persistent data: Dexie over IndexedDB.
- Ephemeral runtime state: `browser.storage.session`.
- Browser target: Chrome MV3.

Build/dev commands:
- `bun install`
- `bun run dev`
- `bun run compile`
- `bun run build`

Relevant config files:
- `package.json`
- `wxt.config.ts`
- `components.json`

## 3) High-level architecture
### Extension entrypoints
- `entrypoints/background.ts`
  - Configures sidepanel behavior on action click.
  - Listens to tab-group removal and clears matching runner sessions.
- `entrypoints/sidepanel/*`
  - Main application UI for runner control and routine management.
- `entrypoints/popup/*`
  - Compact quick-control UI for focused runner.

### Core library modules
- `lib/types.ts`: shared domain types.
- `lib/db.ts`: Dexie schema and DB instance.
- `lib/routines.ts`: routine CRUD utilities, URL normalization, backup import/export parsing.
- `lib/session.ts`: multi-runner session state management and subscriptions.
- `lib/navigation.ts`: start/stop/navigate runner behavior and tab/tab-group orchestration.

### Theme and design system
- `components/theme-provider.tsx`: light/dark persistence and class toggling.
- `components/theme-toggle.tsx`: UI toggle control.
- `entrypoints/shared/styles.css`: design tokens and shared styling foundation.

## 4) Data model and schemas
### 4.1 Routine (IndexedDB)
Defined in `lib/types.ts`, persisted via Dexie in `lib/db.ts`.

```ts
interface Routine {
  id?: number;
  name: string;
  links: Array<{ id: string; url: string; title?: string }>;
  createdAt: number;
  updatedAt: number;
}
```

Dexie store definition:
- DB name: `WebRoutinesDB`
- Table: `routines`
- Indexes: `++id,name,createdAt,updatedAt`

### 4.2 Runner session (session storage)
Defined in `lib/types.ts`.

```ts
interface RoutineSession {
  routineId: number;
  mode: 'same-tab' | 'tab-group';
  currentIndex: number;
  tabId: number | null;
  tabGroupId: number | null;
  tabIds: number[];
  startedAt: number;
}
```

Session storage keys managed by `lib/session.ts`:
- `activeSessions`: `RoutineSession[]`
- `focusedRoutineId`: `number | null`
- Legacy migration key: `activeSession` (read and migrated, then removed)

State rules:
- Multiple sessions can exist simultaneously.
- At most one session per `routineId`.
- `focusedRoutineId` points to the session controlled by sidepanel runner actions and popup actions.
- If focus becomes invalid, first session is used as fallback.

### 4.3 Backup JSON schema
Export payload generated by `createRoutineBackupPayload` in `lib/routines.ts`:

```json
{
  "version": 1,
  "exportedAt": "2026-02-06T...Z",
  "routines": [
    {
      "name": "Routine name",
      "links": [
        { "url": "https://...", "title": "Optional" }
      ]
    }
  ]
}
```

Import parser behavior:
- Accepts both root object with `routines[]` and direct routine array.
- Validates URLs to `http`/`https`.
- Trims names, deduplicates links by URL per routine.
- Skips invalid routines/links and throws if nothing valid remains.

## 5) Current UI structure and behavior
## 5.1 Sidepanel (`entrypoints/sidepanel/App.tsx`)
Single React component with internal view switching:
- `runner` view (default)
- `routines` view
- `editor` view

### Runner Home view
Main cards:
1. Header card
- Title and description.
- Button: `Manage routines` -> switches to routines view.
- Theme toggle.

2. Active Runners card
- Lists currently active routine sessions.
- Shows routine name, mode label, focus badge.
- Actions per runner:
  - `Focus`
  - `Stop`

3. Focused Runner card
- Displays focused routine name and current step.
- Controls:
  - Previous/Next
  - Open current
  - Stop
  - Jump-to-step buttons for each routine link
- Keyboard shortcuts:
  - `Alt+Shift+Left` -> previous
  - `Alt+Shift+Right` -> next

### Routines view
Main cards:
1. Header card
- Back button to Runner Home.
- Theme toggle.

2. Actions card
- `New routine`
- `Export JSON`
- `Import JSON`

3. All routines card
- Lists routines and links.
- Shows `Running` badge if routine already has an active runner.
- Actions:
  - `Run single-tab`
  - `Run multi-tab`
  - `Edit`
  - `Delete`

### Editor view
Main cards:
1. Header card
- Back button to Routines.
- Theme toggle.

2. Form card
- Routine name input.
- Add-link input.
- Draft link list with drag-and-drop reorder.
- Link remove action.
- Save and cancel actions.

Shared UX behaviors:
- Busy-action disabling to avoid repeated operations.
- Error and success messages shown as cards at bottom.
- `navigator.storage.persist()` is requested to reduce storage eviction risk.

## 5.2 Popup (`entrypoints/popup/App.tsx`)
Purpose: quick controls for focused runner when sidepanel is closed/minimized.

Displayed info:
- Active runner count.
- Focused routine name and current step.

Actions:
- Previous / Next
- Open current
- Stop
- Next runner (cycles focus if multiple sessions exist)
- Open sidepanel

Hotkeys:
- `Alt+Shift+Left` and `Alt+Shift+Right` for focused runner navigation.

## 6) Runner lifecycle and navigation logic
Implemented mainly in `lib/navigation.ts` and `lib/session.ts`.

## 6.1 Start routine flow
Function: `startRoutine(routine, mode)`.

Rules:
- Routine must be saved (`id` required).
- Routine must have at least one link.
- If session for `routineId` already exists:
  - No duplicate session is created.
  - Existing session is focused.
  - Returns `alreadyRunning: true`.

If new session needed:
- Mode `same-tab`:
  - Creates one dedicated tab and groups it.
  - Reuses that tab for step navigation by URL updates.
- Mode `tab-group`:
  - Creates one tab per routine link and groups them.
  - Navigation activates existing target tab; no URL rewrite on existing tab.

## 6.2 Navigation
Functions:
- `navigateSessionByOffset(routineId, offset)`
- `navigateToIndex(routine, session, index)`
- `openCurrentSessionLink(routineId)`

Mode behavior:
- Single-tab mode:
  - Updates one tracked tab URL to target step.
  - If tracked tab is gone, creates replacement tab and re-groups when possible.
- Multi-tab mode:
  - Activates target tab if present.
  - Creates missing tab only when needed and attempts to reattach it to group.
  - Avoids forced URL rewrite refresh for existing tabs.

## 6.3 Stop/delete cleanup
- `stopActiveRoutine(routineId)` destroys that routine session and closes owned tabs.
- Deleting a routine from sidepanel first tries stopping its session, then deletes DB record.
- Tabs are closed via `browser.tabs.remove` on deduped session tab ids.

## 6.4 External cleanup triggers
Background listener in `entrypoints/background.ts`:
- On `browser.tabGroups.onRemoved`, session entries with same `tabGroupId` are removed.
- Prevents stale runner sessions when user manually deletes tab groups.

## 7) Session and focus model details
`lib/session.ts` responsibilities:
- Read/write canonical `RunnerState` (`sessions` + `focusedRoutineId`).
- Normalize and dedupe sessions by `routineId`.
- Maintain valid focus.
- Provide subscription helpers using `browser.storage.onChanged`.
- Provide compatibility wrappers (`getActiveSession`, `setActiveSession`, etc.) for older single-runner callsites.
- Migrate legacy `activeSession` to new model automatically.

Focus semantics:
- All runner controls in sidepanel Runner Home and popup act on focused routine unless a routineId is explicitly provided.
- Starting existing runner or manually focusing sets that routine as focused.

## 8) Theming and visual system
- Theme state key: `webroutines-theme` in `localStorage`.
- `ThemeProvider` applies `light`/`dark` class on `document.documentElement`.
- Shared CSS variables live in `entrypoints/shared/styles.css`.
- Sidepanel and popup both import shared styles and are wrapped by `ThemeProvider`.

## 9) Permissions and Chrome API usage
Manifest permissions in `wxt.config.ts`:
- `storage`
- `tabGroups`
- `unlimitedStorage`

APIs used:
- `browser.sidePanel.*`
- `browser.tabs.*`
- `browser.tabGroups.*`
- `browser.storage.session`
- `browser.storage.onChanged`

## 10) Important project decisions
Current behavior decisions:
- One runner max per routine id.
- Multiple routines can run concurrently.
- Both run modes are tab-group-backed to isolate runner-owned tabs from user normal browsing.
- Stopping a runner is destructive for that runner's tabs (tabs are closed).
- Starting an already-running routine focuses existing runner instead of replacing/restarting.

## 11) Known limitations and risks
- No automated test suite yet (behavior validated via compile/build/manual flow).
- Sidepanel view routing is component-state-based, not URL/router-based.
- Multi-tab session stores `tabIds` with possible sparse behavior fallback; cleanup logic ignores invalid ids.
- No sync/cloud account model yet; data is local only (with JSON backup import/export).
- No per-runner metadata beyond session + routine (for example custom group colors, labels, paused status).

## 12) Suggested next improvement areas
Product/UX:
- Add per-runner "Restart" and "Resume from step" options.
- Add runner history and recent routine quick start.
- Add richer URL labels/titles and inline editable link metadata.
- Add bulk routine operations and search/filter.

Reliability:
- Add tab event listeners (`tabs.onRemoved`, `tabs.onUpdated`) to keep sessions tighter to reality.
- Add lightweight telemetry/logging in dev mode for session transitions.

Architecture:
- Split sidepanel `App.tsx` into smaller components/modules.
- Introduce typed action/state reducers for clearer state transitions.
- Add unit tests around `lib/session.ts` and `lib/navigation.ts`.

Data:
- Optional browser sync for lightweight routine metadata.
- Future cloud sync/offline conflict strategy if needed.

## 13) File map (quick orientation)
- `entrypoints/background.ts`
- `entrypoints/sidepanel/App.tsx`
- `entrypoints/sidepanel/main.tsx`
- `entrypoints/popup/App.tsx`
- `entrypoints/popup/main.tsx`
- `entrypoints/shared/styles.css`
- `lib/types.ts`
- `lib/db.ts`
- `lib/routines.ts`
- `lib/session.ts`
- `lib/navigation.ts`
- `components/theme-provider.tsx`
- `components/theme-toggle.tsx`
- `README.md`
- `docs/PRD.md`
- `feature-list-1.md`
- `feature-list-2.md`

## 14) Context prompt you can paste into normal chat
Use this starter prompt with this document:

"You are helping me improve a Chrome MV3 extension called WebRoutines. Read the attached project context and propose improvements for [area]. Keep proposals compatible with current architecture (WXT + React + Dexie + session-based multi-runner tab-group model), and include migration-safe implementation steps."

